<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>wikidata アニメ・漫画作品の人物関係性クイズ</title>
  <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
  <style>
    /* Google-like Reset & Base Styles */
    body {
      font-family: arial, sans-serif;
      background: #fff;
      margin: 0;
      color: #202124;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    /* Header / Logo Area */
    .header-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 60px;
      /* Google-like spacing */
      margin-bottom: 20px;
      width: 100%;
    }

    .title {
      font-size: 2.5rem;
      /* Larger logo-like font */
      font-weight: 500;
      letter-spacing: -1px;
      margin: 0 0 20px 0;
      text-align: center;
      line-height: 1.2;
    }

    /* Google Logo Colors approximation for the title text */
    .logo-blue {
      color: #4285f4;
    }

    .logo-red {
      color: #ea4335;
    }

    .logo-yellow {
      color: #fbbc05;
    }

    .logo-green {
      color: #34a853;
    }

    /* Search Area */
    .search-box-wrap {
      width: 100%;
      max-width: 584px;
      /* Typical Google search bar width */
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0 20px;
      box-sizing: border-box;
    }

    .search-box-inner {
      width: 100%;
      position: relative;
      display: flex;
      align-items: center;
    }

    /* Search Input: Rounded, Shadow on hover */
    #searchInput {
      width: 100%;
      height: 44px;
      border-radius: 24px;
      border: 1px solid #dfe1e5;
      padding: 0 45px 0 45px;
      /* Space for icons */
      font-size: 16px;
      outline: none;
      color: #202124;
      transition: box-shadow 0.2s, background-color 0.2s;
    }

    #searchInput:hover,
    #searchInput:focus {
      box-shadow: 0 1px 6px rgba(32, 33, 36, .28);
      border-color: rgba(223, 225, 229, 0);
    }

    /* Search Icon (Pseudo-element for visual only) */
    .search-box-inner::before {
      content: '';
      position: absolute;
      left: 14px;
      width: 20px;
      height: 20px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' focusable='false' viewBox='0 0 24 24'%3E%3Cpath fill='%239aa0a6' d='M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: center;
    }

    /* Button Area */
    .button-area {
      margin-top: 28px;
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .search-btn {
      background-color: #f8f9fa;
      border: 1px solid #f8f9fa;
      border-radius: 4px;
      color: #3c4043;
      font-family: arial, sans-serif;
      font-size: 14px;
      margin: 0;
      padding: 0 16px;
      line-height: 27px;
      height: 36px;
      min-width: 54px;
      text-align: center;
      cursor: pointer;
      user-select: none;
    }

    .search-btn:hover {
      box-shadow: 0 1px 1px rgba(0, 0, 0, .1);
      background-color: #f8f9fa;
      border: 1px solid #dadce0;
      color: #202124;
    }

    .search-btn:disabled {
      opacity: 0.6;
      cursor: default;
    }

    /* Loading Indicator */
    #loadingIndicator {
      margin-top: 10px;
      font-size: 14px;
    }

    /* Suggestion Area */
    #workSuggest {
      margin-top: 20px;
      width: 100%;
      text-align: center;
    }

    #workSuggest button {
      background: #fff;
      border: 1px solid #dadce0;
      border-radius: 18px;
      padding: 8px 16px;
      margin: 4px;
      color: #1a0dab;
      cursor: pointer;
      font-size: 14px;
    }

    #workSuggest button:hover {
      background: #f1f3f4;
      text-decoration: underline;
    }

    /* Main Content Container */
    .container {
      width: 100%;
      max-width: 1200px;
      /* Standard width */
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 24px;
      padding: 24px;
      box-sizing: border-box;
      flex-wrap: wrap;
      /* Responsive wrap */
    }

    /* Card Style for Main Area & Sidepanel */
    .main-area,
    .sidepanel {
      background: #fff;
      border: 1px solid #dadce0;
      /* Subtle border */
      border-radius: 8px;
      padding: 24px;
      box-shadow: none;
      /* Google usually flat or very subtle */
    }

    .main-area {
      flex: 1 1 600px;
      /* Grow, shrink, base width */
      min-width: 300px;
    }

    .sidepanel {
      flex: 0 0 320px;
      min-width: 300px;
      height: auto;
      max-height: 80vh;
      overflow-y: auto;
      position: sticky;
      top: 20px;
    }

    /* Cytoscape Container */
    #cy {
      width: 100%;
      height: 400px;
      border: 1px solid #dadce0;
      border-radius: 8px;
      background: #f8f9fa;
      margin-top: 20px;
    }

    /* Typography & Utilities */
    .alert {
      background: #fce8e6;
      color: #c5221f;
      border: 1px solid #fce8e6;
      padding: 12px;
      border-radius: 4px;
      display: inline-block;
      margin-top: 10px;
    }

    .work-title {
      font-size: 20px;
      color: #202124;
      margin-bottom: 12px;
    }

    .character-list {
      font-size: 14px;
      color: #4d5156;
      line-height: 1.58;
      margin-bottom: 20px;
    }

    .character-list span {
      display: inline-block;
      background: #f1f3f4;
      border-radius: 12px;
      padding: 2px 10px;
      margin: 2px;
      font-size: 12px;
    }

    /* Quiz Area */
    .quiz-area {
      margin: 20px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .option-btn {
      display: block;
      width: 100%;
      text-align: left;
      background: #fff;
      border: 1px solid #dadce0;
      padding: 10px 16px;
      margin: 8px 0;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      color: #202124;
    }

    .option-btn:hover {
      background: #f1f3f4;
      border-color: #dadce0;
    }

    /* Legend */
    #legend {
      position: relative;
      /* Changed from absolute to flow naturally or be placed inside graphTitle */
      background: transparent;
      box-shadow: none;
      padding: 10px 0;
      font-size: 12px;
      color: #5f6368;
    }

    /* History Buttons */
    .history-btn {
      background: #fff;
      border: 1px solid #dadce0;
      border-radius: 16px;
      padding: 6px 12px;
      margin: 4px;
      font-size: 12px;
      cursor: pointer;
      color: #1a0dab;
    }

    .history-btn:hover {
      background: #f1f3f4;
    }

    /* Mode Switch */
    .mode-switch {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
      font-size: 14px;
      color: #3c4043;
    }

    .mode-switch label {
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Responsive adjustments */
    @media (max-width: 800px) {
      .container {
        flex-direction: column;
        align-items: center;
      }

      .main-area,
      .sidepanel {
        width: 100%;
        flex: none;
      }

      .sidepanel {
        position: static;
        max-height: none;
      }
    }
  </style>
</head>

<body>

  <!-- Header / Logo Area -->
  <div class="header-area">
    <div class="title">
      <span class="logo-blue">W</span><span class="logo-red">i</span><span class="logo-yellow">k</span><span
        class="logo-blue">i</span><span class="logo-green">d</span><span class="logo-red">a</span><span
        class="logo-blue">t</span><span class="logo-yellow">a</span>
      <span style="font-size: 0.8em; color: #5f6368; display: block; margin-top: 8px;">人物関係クイズ</span>
    </div>
  </div>

  <!-- Search Area -->
  <div class="search-box-wrap">
    <!-- Mode Switch UI -->
    <div class="mode-switch">
      <label><input type="radio" name="mode" value="work" checked onclick="setMode('work')"> 作品モード</label>
      <label><input type="radio" name="mode" value="person" onclick="setMode('person')"> 歴史人物モード</label>
    </div>

    <div class="search-box-inner">
      <input type="text" id="searchInput" placeholder="作品名を入力（例：ドラえもん、鬼滅の刃）">
    </div>

    <div class="button-area">
      <!-- Modified onclick to branch logic -->
      <button class="search-btn" id="searchBtn" onclick="handleSearch()">作品検索</button>
      <!-- Dummy button for Google look -->
      <button class="search-btn" onclick="handleSearch()">I'm Feeling Lucky</button>
    </div>

    <span id="loadingIndicator" style="display:none; color:#4285f4; font-weight:bold; margin-top:10px;">ロード中…</span>
    <div id="workSuggest"></div>
  </div>

  <!-- Main Content Container -->
  <div class="container">
    <div class="main-area">
      <div id="characterList"></div>
      <div id="quizConfig"></div>
      <div class="quiz-area" id="quizArea"></div>
      <div id="graphTitle"></div>
      <div id="cy"></div>
    </div>
    <div class="sidepanel" id="sidepanel"></div>
  </div>

  <script>
    const endpoint = "https://query.wikidata.org/sparql";
    let selectedWorkID = "", selectedWorkLabel = "", characterArr = [], quizList = [];
    let graphHistory = [];
    let currentMode = 'work'; // 'work' or 'person'
    const MAX_HISTORY = 3;

    const edgeColors = {
      P22: "#e74c3c", P25: "#9b59b6", P3373: "#3498db", P26: "#e67e22",
      P40: "#2ecc71", P1038: "#16a085", P1066: "#f1c40f"
    };
    const relationProps = [
      { prop: 'P22', label: '父' }, { prop: 'P25', label: '母' }, { prop: 'P3373', label: '兄弟姉妹' },
      { prop: 'P26', label: '配偶者' }, { prop: 'P40', label: '子' }, { prop: 'P1038', label: '親族' }, { prop: 'P1066', label: '師匠' }
    ];
    const templates = {
      'P22': n => `${n}の父はだれ？`, 'P25': n => `${n}の母はだれ？`,
      'P3373': n => `${n}の兄弟姉妹はだれ？`, 'P26': n => `${n}の配偶者はだれ？`,
      'P40': n => `${n}の子はだれ？`, 'P1038': n => `${n}の親族はだれ？`, 'P1066': n => `${n}の師匠はだれ？`
    };
    const genreQids = [
      "Q5398426",    // テレビシリーズ
      "Q21198342",    // 日本の連載漫画（※ゼロ1個修正済み！）
      "Q196600"      // メディア・フランチャイズ
    ];

    // --- モード設定 ---
    function setMode(mode) {
      currentMode = mode;
      const input = document.getElementById('searchInput');
      const searchBtn = document.getElementById('searchBtn');
      if (mode === 'work') {
        input.placeholder = "作品名を入力（例：ドラえもん、鬼滅の刃）";
        searchBtn.textContent = "作品検索";
      } else {
        input.placeholder = "歴史人物を入力（例：織田信長）";
        searchBtn.textContent = "人物検索";
      }
      // クリア
      document.getElementById('workSuggest').innerHTML = '';
      document.getElementById('characterList').innerHTML = '';
      document.getElementById('quizConfig').innerHTML = '';
      document.getElementById('quizArea').innerHTML = '';
      document.getElementById('cy').innerHTML = '';
      document.getElementById('sidepanel').innerHTML = '';
      document.getElementById('graphTitle').innerHTML = '';
    }

    function handleSearch() {
      if (currentMode === 'work') {
        searchWorks();
      } else {
        searchPersons();
      }
    }

    // --- 既存: 作品検索 ---
    async function searchWorks() {
      const searchBtn = document.getElementById('searchBtn');
      const loading = document.getElementById('loadingIndicator');
      if (searchBtn) searchBtn.disabled = true;
      if (loading) loading.style.display = '';
      let word = document.getElementById('searchInput').value;
      if (!word || word.length < 2) {
        document.getElementById('workSuggest').innerHTML = "<span class='alert'>2文字以上で作品名を入力してください。</span>";
        if (loading) loading.style.display = 'none';
        if (searchBtn) searchBtn.disabled = false;
        return;
      }
      let allResults = [];
      for (const qid of genreQids) {
        let q = `
      SELECT DISTINCT ?item ?itemLabel WHERE {
        ?item wdt:P31/wdt:P279* wd:${qid} .
        ?item rdfs:label ?itemLabel .
        FILTER(LANG(?itemLabel) = "ja")
        FILTER(CONTAINS(?itemLabel, "${word}"))
      }
      ORDER BY ?itemLabel
      LIMIT 7
    `;
        try {
          let res = await runSparql(q);
          allResults.push(...res.results.bindings);
        } catch (e) { }
      }
      // 重複除去
      const seen = new Set();
      const uniqResults = allResults.filter(b => {
        const k = b.item.value;
        if (seen.has(k)) return false;
        seen.add(k); return true;
      });
      let s = "<span class='subtle'>候補作品（QID/5人以上）：</span><br>";
      const checks = await Promise.all(uniqResults.map(async b => {
        let id = b.item.value.split('/').pop();
        let charQ = `SELECT DISTINCT ?character WHERE { wd:${id} wdt:P674 ?character . }`;
        let charRes = await runSparql(charQ);
        let count = Array.from(new Set(charRes.results.bindings.map(c => c.character.value.split('/').pop()))).length;
        return { id, label: b.itemLabel.value, count };
      }));
      checks.filter(obj => obj.count >= 5)
        .forEach(obj => {
          s += `<button onclick="selectWork('${obj.id}','${obj.label}')">${obj.label}(QID:${obj.id}/${obj.count}人)</button><br>`;
        });
      if (s.indexOf("button") === -1) s += "<span class='alert'>該当作品なし（登場人物5人以上のみ表示）</span>";
      document.getElementById('workSuggest').innerHTML = s;
      document.getElementById('characterList').innerHTML = '';
      document.getElementById('quizConfig').innerHTML = '';
      document.getElementById('quizArea').innerHTML = '';
      document.getElementById('cy').innerHTML = '';
      document.getElementById('sidepanel').innerHTML = '';
      document.getElementById('graphTitle').innerHTML = '';
      if (loading) loading.style.display = 'none';
      if (searchBtn) searchBtn.disabled = false;
    }

    // --- 新規: 人物検索 ---
    async function searchPersons() {
      const searchBtn = document.getElementById('searchBtn');
      const loading = document.getElementById('loadingIndicator');
      if (searchBtn) searchBtn.disabled = true;
      if (loading) loading.style.display = '';
      let word = document.getElementById('searchInput').value;
      if (!word) {
        document.getElementById('workSuggest').innerHTML = "<span class='alert'>人物名を入力してください。</span>";
        if (loading) loading.style.display = 'none';
        if (searchBtn) searchBtn.disabled = false;
        return;
      }

      let q = `
        SELECT DISTINCT ?person ?personLabel WHERE {
          ?person wdt:P31 wd:Q5 .
          ?person wdt:P27 wd:Q17 .
          ?person rdfs:label ?personLabel .
          FILTER(LANG(?personLabel) = "ja")
          FILTER(CONTAINS(?personLabel, "${word}"))
        }
        ORDER BY ?personLabel
        LIMIT 10
      `;

      try {
        let res = await runSparql(q);
        let bindings = res.results.bindings;
        let s = "<span class='subtle'>候補人物：</span><br>";

        if (bindings.length === 0) {
          s += "<span class='alert'>該当する日本の歴史上の人物が見つかりません。</span>";
        } else {
          bindings.forEach(b => {
            let id = b.person.value.split('/').pop();
            let label = b.personLabel.value;
            s += `<button onclick="selectPerson('${id}','${label}')">${label} (${id})</button><br>`;
          });
        }
        document.getElementById('workSuggest').innerHTML = s;
        // Reset areas
        document.getElementById('characterList').innerHTML = '';
        document.getElementById('quizConfig').innerHTML = '';
        document.getElementById('quizArea').innerHTML = '';
        document.getElementById('cy').innerHTML = '';
        document.getElementById('sidepanel').innerHTML = '';
        document.getElementById('graphTitle').innerHTML = '';

      } catch (e) {
        document.getElementById('workSuggest').innerHTML = `<span class='alert'>エラーが発生しました: ${e.message}</span>`;
      } finally {
        if (loading) loading.style.display = 'none';
        if (searchBtn) searchBtn.disabled = false;
      }
    }

    async function runSparql(query) {
      let url = endpoint + "?query=" + encodeURIComponent(query);
      let headers = { 'Accept': 'application/sparql-results+json' };

      // リトライロジック追加
      const maxRetries = 3;
      let attempt = 0;

      while (attempt < maxRetries) {
        try {
          let resp = await fetch(url, { headers });
          if (!resp.ok) throw new Error(`SPARQL fetch failed: ${resp.status}`);
          return await resp.json();
        } catch (e) {
          attempt++;
          console.warn(`SPARQL attempt ${attempt} failed:`, e);
          if (attempt >= maxRetries) throw e;
          // Exponential backoff: 500ms, 1000ms, 2000ms...
          await new Promise(r => setTimeout(r, 500 * Math.pow(2, attempt - 1)));
        }
      }
    }
    async function fetchCharactersFlexible(workQid, workLabel) {
      let q = `SELECT DISTINCT ?character ?characterLabel WHERE {
    wd:${workQid} wdt:P674 ?character .
    SERVICE wikibase:label { bd:serviceParam wikibase:language "ja,en". }
  } LIMIT 40`;
      let res = await runSparql(q);
      return res.results.bindings;
    }
    async function selectWork(id, label) {
      selectedWorkID = id; selectedWorkLabel = label;
      characterArr = await fetchCharactersFlexible(id, label);
      if (characterArr.length === 0) {
        document.getElementById('characterList').innerHTML =
          `<span class='alert'>登場人物未取得（0名）。Wikidataのデータ不足、または表記ゆれの可能性があります。</span>`;
        document.getElementById('quizConfig').innerHTML = '';
        document.getElementById('quizArea').innerHTML = '';
        document.getElementById('cy').innerHTML = '';
        document.getElementById('sidepanel').innerHTML = '';
        document.getElementById('graphTitle').innerHTML = '';
        return;
      }
      let out = `<div class="work-title">${selectedWorkLabel}（登場人物${characterArr.length}名）</div>`;
      out += `<div class="character-list">`;
      characterArr.forEach(obj => {
        out += `<span>${obj.characterLabel?.value || obj.character.value.split('/').pop()}</span> `;
      });
      out += `</div>`;
      document.getElementById('characterList').innerHTML = out;
      showQuizConfig();
      document.getElementById('quizArea').innerHTML = '';
      document.getElementById('cy').innerHTML = '';
      document.getElementById('sidepanel').innerHTML = '';
      document.getElementById('graphTitle').innerHTML = '';
    }

    // --- 新規: selectPerson ---
    async function selectPerson(id, label) {
      selectedWorkID = id; // ここに起点人物IDを入れる
      selectedWorkLabel = label;

      // 周辺人物検索クエリ
      let q = `
            SELECT DISTINCT ?item ?itemLabel WHERE {
              { wd:${id} ?p ?item. } UNION { ?item ?p wd:${id}. }
              ?item wdt:P31 wd:Q5.
              ?item wdt:P27 wd:Q17.
              SERVICE wikibase:label { bd:serviceParam wikibase:language "ja,en". }
            }
        `;
      let res = await runSparql(q);
      let relatedPeople = res.results.bindings;

      // characterArr互換の構造に変換 (character, characterLabelプロパティを持たせる)
      characterArr = relatedPeople.map(b => ({
        character: b.item,
        characterLabel: b.itemLabel
      }));

      if (characterArr.length === 0) {
        document.getElementById('characterList').innerHTML = `<span class='alert'>関係人物が見つかりませんでした。</span>`;
        return;
      }

      let out = `<div class="work-title">${selectedWorkLabel}（関係人物${characterArr.length}名）</div>`;
      out += `<div class="character-list">`;
      characterArr.forEach(obj => {
        out += `<span>${getLabel(obj, 'character')}</span> `;
      });
      out += `</div>`;
      document.getElementById('characterList').innerHTML = out;

      // クイズ生成ボタン (startPersonQuizを呼ぶ)
      let html = `<button class="search-btn" id="quizGenBtn" style="margin:12px 0;" onclick="startPersonQuiz(5)">クイズ生成</button>
      <span id="quizLoading" style="display:none; color:#4096d8; font-weight:bold; margin-left:1em;">ロード中…</span>`;
      document.getElementById('quizConfig').innerHTML = html;

      document.getElementById('quizArea').innerHTML = '';
      document.getElementById('cy').innerHTML = '';
      document.getElementById('sidepanel').innerHTML = '';
      document.getElementById('graphTitle').innerHTML = '';
    }

    function showQuizConfig() {
      let html = `<button class="search-btn" id="quizGenBtn" style="margin:12px 0;" onclick="startQuiz(5)">クイズ生成</button>
    <span id="quizLoading" style="display:none; color:#4096d8; font-weight:bold; margin-left:1em;">ロード中…</span>`;
      document.getElementById('quizConfig').innerHTML = html;
    }

    // ラベル取得ヘルパー: ラベルが存在し、かつ空でない場合にのみ使用。なければID。
    function getLabel(binding, varName) {
      if (binding[varName + 'Label'] && binding[varName + 'Label'].value && binding[varName + 'Label'].value.trim()) {
        return binding[varName + 'Label'].value;
      }
      return binding[varName].value.split('/').pop();
    }

    async function startQuiz(num) {
      const quizBtn = document.getElementById('quizGenBtn');
      const quizLoading = document.getElementById('quizLoading');
      if (quizBtn) quizBtn.disabled = true;
      if (quizLoading) quizLoading.style.display = '';
      quizList = []; let candidArr = characterArr.slice(), loop = 0;
      try {
        for (let i = 0; i < num; i++) {
          if (candidArr.length === 0 || loop > 100) break; loop++;
          let idx = Math.floor(Math.random() * candidArr.length);
          let chara = candidArr.splice(idx, 1)[0];
          let relObj = relationProps[Math.floor(Math.random() * relationProps.length)];
          let charaId = chara.character.value.split('/').pop();
          // 修正: ラベル取得ロジックの強化
          let charaLabel = getLabel(chara, 'character');

          let q = `SELECT ?target ?targetLabel WHERE {
        wd:${charaId} wdt:${relObj.prop} ?target.
        SERVICE wikibase:label { bd:serviceParam wikibase:language "ja, en". }
      } LIMIT 1`;
          let res = await runSparql(q);
          if (res.results.bindings.length === 0) { i--; continue; }
          let correct = res.results.bindings[0];

          // 修正: ラベル取得ロジックの強化
          let correctLabel = getLabel(correct, 'target');
          let correctObj = {
            id: correct.target.value.split('/').pop(),
            label: correctLabel
          };

          let others = characterArr.filter(o => o.character.value.split('/').pop() !== charaId);
          let wrongs = [];
          while (wrongs.length < 3 && others.length > 0) {
            let widx = Math.floor(Math.random() * others.length);
            let witem = others.splice(widx, 1)[0];
            let wId = witem.character.value.split('/').pop();
            // 修正: ラベル取得ロジックの強化
            let wLabel = getLabel(witem, 'character');
            wrongs.push({
              id: wId,
              label: wLabel
            });
          }
          quizList.push({
            question: templates[relObj.prop](charaLabel),
            correct: correctObj, wrongs: wrongs, chara: { id: charaId, label: charaLabel }, relation: relObj
          });
        }
        score = 0; userAnswers = [];
        showQuizQuestion(0);
      } finally {
        if (quizBtn) quizBtn.disabled = false;
        if (quizLoading) quizLoading.style.display = 'none';
      }
    }

    // --- 新規: startPersonQuiz ---
    async function startPersonQuiz(num) {
      const quizBtn = document.getElementById('quizGenBtn');
      const quizLoading = document.getElementById('quizLoading');
      if (quizBtn) quizBtn.disabled = true;
      if (quizLoading) quizLoading.style.display = '';
      quizList = [];
      let candidArr = characterArr.slice();
      let loop = 0;

      try {
        for (let i = 0; i < num; i++) {
          if (candidArr.length === 0 || loop > 100) break; loop++;
          // ランダムに1人選ぶ
          let idx = Math.floor(Math.random() * candidArr.length);
          let chara = candidArr.splice(idx, 1)[0];

          let relObj = relationProps[Math.floor(Math.random() * relationProps.length)];
          let charaId = chara.character.value.split('/').pop();
          let charaLabel = getLabel(chara, 'character');

          // 関係先を取得 (既存startQuizと同じロジックを再利用)
          let q = `SELECT ?target ?targetLabel WHERE {
            wd:${charaId} wdt:${relObj.prop} ?target.
            SERVICE wikibase:label { bd:serviceParam wikibase:language "ja, en". }
          } LIMIT 1`;

          let res = await runSparql(q);
          if (res.results.bindings.length === 0) { i--; continue; }
          let correct = res.results.bindings[0];
          let correctLabel = getLabel(correct, 'target');

          let correctObj = {
            id: correct.target.value.split('/').pop(),
            label: correctLabel
          };

          // 誤答候補作成
          let others = characterArr.filter(o => o.character.value.split('/').pop() !== charaId);
          let wrongs = [];
          while (wrongs.length < 3 && others.length > 0) {
            let widx = Math.floor(Math.random() * others.length);
            let witem = others.splice(widx, 1)[0];
            let wId = witem.character.value.split('/').pop();
            let wLabel = getLabel(witem, 'character');

            // 正解と同じ人物でないか確認 (念のため)
            if (wId === correctObj.id) {
              continue;
            }
            wrongs.push({ id: wId, label: wLabel });
          }

          quizList.push({
            question: templates[relObj.prop](charaLabel),
            correct: correctObj, wrongs: wrongs, chara: { id: charaId, label: charaLabel }, relation: relObj
          });
        }
        score = 0; userAnswers = [];
        showQuizQuestion(0);
      } finally {
        if (quizBtn) quizBtn.disabled = false;
        if (quizLoading) quizLoading.style.display = 'none';
      }
    }

    let currentQuiz = 0, score = 0, userAnswers = [];
    function showQuizQuestion(idx) {
      if (idx >= quizList.length) {
        document.getElementById('quizArea').innerHTML =
          `<div class="result">クイズ終了　スコア: ${score}/${quizList.length}</div><button onclick="drawGraph()">人物関係グラフ表示へ</button>`;
        return;
      }
      let q = quizList[idx], opts = [q.correct, ...q.wrongs];
      for (let i = opts.length - 1; i > 0; i--) { let j = Math.floor(Math.random() * (i + 1));[opts[i], opts[j]] = [opts[j], opts[i]]; }
      let html = `<strong>Q${idx + 1}: ${q.question}</strong><br>`;
      opts.forEach(o => {
        html += `<button class="option-btn" onclick="submitAnswer('${o.id}','${q.correct.id}','${o.label}','${q.correct.label}')">${o.label}</button><br>`;
      });
      html += `<div>現在のスコア: ${score}/${idx}</div>`;
      document.getElementById('quizArea').innerHTML = html; currentQuiz = idx;
    }
    function submitAnswer(ans, cor, selectedLabel, correctLabel) {
      let correct = (ans === cor); userAnswers.push({ correct, selectedLabel, correctLabel });
      if (correct) score++;
      let resultHtml = `<strong style="font-size:1.23em;">${correct ? "正解！" : "不正解"}</strong><br>`;
      resultHtml += `あなたの選択：<span style="font-weight:bold;">${selectedLabel}</span><br>`;
      if (!correct) {
        resultHtml += `正しい答え：<span style="font-weight:bold; color:#4096d8">${correctLabel}</span><br>`;
      }
      resultHtml += `<button class="search-btn" onclick="showQuizQuestion(currentQuiz+1)" style="margin-top:1em;">次の問題へ</button>`;
      resultHtml += `<div style="margin-top:8px;">現在のスコア: ${score}/${currentQuiz + 1}</div>`;
      document.getElementById('quizArea').innerHTML = resultHtml;
    }

    // 凡例HTML生成ヘルパー
    function getLegendHtml() {
      let legendHtml = '<div id="legend">'
        + '<span style="font-weight:bold;">関係性カラー：</span><br>';
      relationProps.forEach(r => {
        legendHtml += `<span style="display:inline-block; margin:3px 13px 3px 0;">
      <svg style="vertical-align:middle;" width="29" height="20">
        <defs><marker id="arrow_${r.prop}" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="7" markerHeight="7" orient="auto">
          <path d="M 0 0 L 10 5 L 0 10 z" fill="${edgeColors[r.prop]}"/>
        </marker></defs>
        <line x1="3" y1="12" x2="25" y2="12" stroke="${edgeColors[r.prop]}" stroke-width="4" marker-end="url(#arrow_${r.prop})"/>
      </svg>
      <span style="margin-left:2px;">${r.label}</span>
    </span>`;
      });
      legendHtml += '</div>';
      return legendHtml;
    }

    // 共通Cytoscape描画関数
    function renderCytoscape(nodes, edges) {
      let cy = cytoscape({
        container: document.getElementById('cy'),
        elements: [...nodes, ...edges],
        style: [
          { selector: 'node', style: { 'label': 'data(label)', 'background-color': '#4096d8', 'width': 40, 'height': 40 } },
          {
            selector: 'edge', style: {
              'line-color': 'data(edgeColor)',
              'width': 5,
              'curve-style': 'bezier',
              'target-arrow-shape': 'triangle',
              'target-arrow-color': 'data(edgeColor)',
              'label': ''
            }
          },
        ],
        layout: { name: 'cose' }
      });
      cy.edges().forEach(edge => {
        const prop = edge.data('relation')?.prop;
        edge.data('edgeColor', edgeColors[prop] || '#c56');
      });
      cy.style().update();

      // イベントハンドラ設定 (マウスオーバーでラベル表示)
      cy.on('mouseover', 'edge', function (evt) {
        const edge = evt.target;
        const rel = edge.data('relation');
        if (rel && rel.label) edge.style('label', rel.label);
      });
      cy.on('mouseout', 'edge', function (evt) {
        evt.target.style('label', '');
      });

      // タッチ端末対応
      let lastTapEdge = null;
      cy.on('tap', 'edge', function (evt) {
        if (lastTapEdge) lastTapEdge.style('label', '');
        lastTapEdge = evt.target;
        const rel = lastTapEdge.data('relation');
        if (rel && rel.label) lastTapEdge.style('label', rel.label);
      });
      cy.on('tapend', function () {
        if (lastTapEdge) lastTapEdge.style('label', '');
        lastTapEdge = null;
      });

      // ノードクリックで詳細表示
      cy.on('tap', 'node', evt => {
        let nodeId = evt.target.data('id'); showSidePanel(nodeId);
      });

      return cy;
    }

    // ---- グラフ一式＋エッジホバーラベル追加！ ----
    function drawGraph() {
      document.getElementById('graphTitle').innerHTML = getLegendHtml();

      let nodes = [], edges = [];
      quizList.forEach(q => {
        if (!nodes.some(n => n.data.id === q.chara.id)) nodes.push({ data: { id: q.chara.id, label: q.chara.label } });
        if (!nodes.some(n => n.data.id === q.correct.id)) nodes.push({ data: { id: q.correct.id, label: q.correct.label } });
        edges.push({
          data: {
            id: q.chara.id + q.correct.id,
            source: q.chara.id,
            target: q.correct.id,
            relation: q.relation
          }
        });
      });

      // 共通関数で描画
      renderCytoscape(nodes, edges);

      document.getElementById('quizArea').innerHTML = '';

      // 履歴保存
      saveGraphHistory({
        qid: selectedWorkID,
        kind: "normal",
        nodes: JSON.parse(JSON.stringify(nodes)),
        edges: JSON.parse(JSON.stringify(edges)),
        title: selectedWorkLabel,
        timestamp: new Date() // Dateオブジェクトとして保存
      });
    }

    // 履歴グラフの再描画
    function showHistoryGraph(idx) {
      let rec = graphHistory[idx];
      // タイトルと凡例の両方を表示
      document.getElementById('graphTitle').innerHTML = `<div><strong>${rec.title}</strong></div>` + getLegendHtml();
      renderCytoscape(rec.nodes, rec.edges);
    }

    // --- 履歴リスト/合体候補表示、プレビュー＆合体 ---
    function renderGraphHistoryList() {
      let qidGroups = {};
      graphHistory.forEach((rec, idx) => {
        if (rec.kind !== "merged") {
          if (!qidGroups[rec.qid]) qidGroups[rec.qid] = [];
          qidGroups[rec.qid].push(idx);
        }
      });
      let html = "<div><strong>過去グラフ履歴：</strong></div>";
      graphHistory.forEach((rec, idx) => {
        const date = rec.timestamp.toLocaleTimeString();
        let label = `[${rec.title}${rec.kind === "merged" ? "（合体）" : ""}] ${date}`;
        html += `<button class="history-btn" onclick="showHistoryGraph(${idx})">${label}</button> `;
      });
      // QIDごとに統合候補が2個以上なら合体ボタン
      Object.keys(qidGroups).forEach(qid => {
        if (qidGroups[qid].length >= 2) {
          html += `<br><button style="margin:6px 0;" onclick="mergeGraphsPreview('${qid}')">［${qid} 合体グラフ生成］</button>`;
        }
      });
      document.getElementById('sidepanel').innerHTML = html + "<hr style='margin:12px 0'>";
    }

    // 合体前プレビュー
    function mergeGraphsPreview(qid) {
      let targets = graphHistory.filter(g => g.qid === qid && g.kind !== "merged");
      if (targets.length < 2) return;
      let preview = `<div style="margin:6px 0 12px 0;padding:.6em;border:1px solid #ccc;background:#fcfcfc;">
  <b>合体対象: ${targets.length}件</b><br>`
        + targets.map(g => g.title + " " + g.timestamp.toLocaleTimeString()).join("<br>")
        + `<br><button onclick="doMergeGraphForQID('${qid}')">このグラフで合体実行</button></div>`;
      document.getElementById('sidepanel').innerHTML += preview;
    }

    // 実際に合体して保存
    function doMergeGraphForQID(qid) {
      let targets = graphHistory.filter(g => g.qid === qid && g.kind !== "merged");
      if (!targets.length) return;
      // ノード・エッジ統合
      let allNodes = [];
      let allEdges = [];
      targets.forEach(g => {
        g.nodes.forEach(n => {
          if (!allNodes.some(n2 => n2.data.id === n.data.id)) allNodes.push(JSON.parse(JSON.stringify(n)));
        });
        g.edges.forEach(e => {
          if (!allEdges.some(e2 => e2.data.id === e.data.id)) allEdges.push(JSON.parse(JSON.stringify(e)));
        });
      });

      saveGraphHistory({
        qid: qid,
        kind: "merged",
        nodes: allNodes,
        edges: allEdges,
        title: targets[0]?.title + "（合体）",
        timestamp: new Date() // Dateオブジェクトとして保存
      });
    }

    // 履歴管理（LocalStorage対応）
    function saveGraphHistory(newRec) {
      if (graphHistory.length >= MAX_HISTORY) graphHistory.shift();
      graphHistory.push(newRec);
      // LocalStorage保存時はJSON化（DateはISO文字列になる）
      localStorage.setItem('wikidata_quiz_history', JSON.stringify(graphHistory));
      renderGraphHistoryList();
    }

    function loadGraphHistory() {
      const saved = localStorage.getItem('wikidata_quiz_history');
      if (saved) {
        try {
          graphHistory = JSON.parse(saved);
          // Dateオブジェクト復元
          graphHistory.forEach(rec => {
            if (typeof rec.timestamp === 'string') rec.timestamp = new Date(rec.timestamp);
          });
        } catch (e) {
          console.error("History load failed", e);
          graphHistory = [];
        }
      }
      renderGraphHistoryList();
    }

    // サイドパネルノード詳細
    async function showSidePanel(id) {
      let q = `SELECT ?item ?itemLabel ?desc WHERE {
    VALUES ?item { wd:${id} }
    OPTIONAL { ?item rdfs:label ?itemLabel. FILTER(LANG(?itemLabel)="ja") }
    OPTIONAL{ ?item schema:description ?desc. FILTER(LANG(?desc)="ja") }
  } LIMIT 1`;
      try {
        let res = await runSparql(q);
        let info = res.results.bindings[0];
        let wikidataUrl = 'https://www.wikidata.org/wiki/' + id;
        let html = `<strong>${info?.itemLabel?.value || id}</strong><br>`;
        if (info?.desc) html += `<div>${info.desc.value}</div>`;
        html += `<a href="${wikidataUrl}" target="_blank">Wikidata詳細</a>`;
        document.getElementById('sidepanel').innerHTML += html;
      } catch (e) {
        document.getElementById('sidepanel').innerHTML = '取得エラー';
      }
    }

    // 初期化時に履歴読み込み
    window.addEventListener('DOMContentLoaded', () => {
      loadGraphHistory();
    });
  </script>
</body>

</html>
